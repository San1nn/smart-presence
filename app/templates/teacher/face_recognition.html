<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Registration - Teacher Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff; --primary-hover: #0056b3; --danger: #dc3545;
            --success: #28a745; --info: #17a2b8; --bg-color: #f4f6f9;
            --card-bg: #ffffff; --text-color: #343a40; --border-color: #dee2e6;
        }
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg-color); padding: 2em; }
        .container { max-width: 1000px; margin: auto; }
        .panel { background: var(--card-bg); border-radius: 8px; padding: 1.5em; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2em; }
        .tab-buttons { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 1.5em; }
        .tab-btn { padding: 10px 20px; border: none; background: none; cursor: pointer; font-size: 1rem; font-weight: 500; }
        .tab-btn.active { border-bottom: 3px solid var(--primary-color); font-weight: 600; color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #video { width: 100%; border-radius: 6px; }
        select, button, input[type="file"] { width: 100%; padding: 0.8em; font-size: 1rem; border-radius: 6px; border: 1px solid var(--border-color); box-sizing: border-box; }
        button { background-color: var(--primary-color); color: white; cursor: pointer; border: none; margin-top: 1em; }
        .thumbnails { margin-top: 1em; padding: 10px; border: 1px dashed var(--border-color); min-height: 80px; display: flex; flex-wrap: wrap; gap: 10px; }
        .thumbnails img { width: 70px; height: 70px; object-fit: cover; border-radius: 4px; }
        #statusMessage { margin-top: 1em; padding: 10px; border-radius: 6px; text-align: center; font-weight: 500; display: none; }
        .status-success { background-color: #d4edda; color: #155724; }
        .status-error { background-color: #f8d7da; color: #721c24; }
        .status-info { background-color: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Student Face Registration</h1>
        <div class="panel">
            <div class="form-group" style="margin-bottom: 2em;">
                <label for="studentSelector" style="font-weight: 600;">Select Student:</label>
                <select id="studentSelector" required>
                    <option value="" disabled selected>Select a student to begin</option>
                </select>
            </div>

            <div class="tab-buttons">
                <button class="tab-btn active" onclick="openTab(event, 'webcamTab')">ðŸ“· Use Webcam</button>
                <button class="tab-btn" onclick="openTab(event, 'uploadTab')">ðŸ“‚ Upload Photos</button>
            </div>

            <!-- Webcam Tab -->
            <div id="webcamTab" class="tab-content active">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas" style="display:none;"></canvas>
                <button id="captureBtn" disabled>Capture Photo</button>
                <div id="webcam-thumbnails" class="thumbnails"></div>
                <button id="registerWebcamBtn" disabled>Register Captured Photos</button>
            </div>

            <!-- Upload Tab -->
            <div id="uploadTab" class="tab-content">
                <form id="uploadForm">
                    <label for="fileInput">Select one or more images:</label>
                    <input type="file" id="fileInput" name="images" multiple accept="image/*" disabled>
                    <div id="upload-thumbnails" class="thumbnails"></div>
                    <button type="submit" id="registerUploadBtn" disabled>Register Uploaded Photos</button>
                </form>
            </div>

            <div id="statusMessage"></div>
        </div>

         <div class="panel" style="margin-top: 2em;">
            <h3>Train Model</h3>
            <p>After registering faces for at least two students, train the model.</p>
            <form action="/face-recognition/train" method="post" id="trainForm">
                <button type="submit">Train Recognition Model</button>
            </form>
        </div>
    </div>

    <script>
        // DOM Elements
        const studentSelector = document.getElementById('studentSelector');
        // Webcam
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('captureBtn');
        const webcamThumbnails = document.getElementById('webcam-thumbnails');
        const registerWebcamBtn = document.getElementById('registerWebcamBtn');
        // Upload
        const uploadForm = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const uploadThumbnails = document.getElementById('upload-thumbnails');
        const registerUploadBtn = document.getElementById('registerUploadBtn');
        // Shared
        const statusMessage = document.getElementById('statusMessage');
        let capturedBlobs = [];

        // --- Tab Logic ---
        function openTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        // --- Shared Logic ---
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-${type}`;
            statusMessage.style.display = 'block';
        }

        async function registerFaces(formData) {
            showStatus('Uploading...', 'info');
            try {
                const response = await fetch('/face-recognition/register-faces', {
                    method: 'POST',
                    body: formData,
                });
                const data = await response.json();
                if (response.ok) {
                    showStatus(data.message, 'success');
                    return true;
                } else {
                    showStatus(`Error: ${data.detail}`, 'error');
                    return false;
                }
            } catch (error) {
                showStatus('Connection error. Please try again.', 'error');
                return false;
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Load Students
            try {
                const response = await fetch('/face-recognition/students-for-registration');
                const students = await response.json();
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.roll_number;
                    option.textContent = `${student.name} (${student.roll_number})`;
                    option.dataset.name = student.name;
                    studentSelector.appendChild(option);
                });
            } catch (e) { showStatus('Failed to load students.', 'error'); }

            // Start Webcam
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
            } catch (e) { showStatus('Webcam access denied.', 'error'); }
        });

        // --- Student Selection Logic ---
        studentSelector.addEventListener('change', () => {
            const studentSelected = !!studentSelector.value;
            captureBtn.disabled = !studentSelected;
            fileInput.disabled = !studentSelected;

            // Reset state
            capturedBlobs = [];
            webcamThumbnails.innerHTML = '';
            uploadThumbnails.innerHTML = '';
            registerWebcamBtn.disabled = true;
            registerUploadBtn.disabled = true;
            fileInput.value = ''; // Clear file selection
        });

        // --- Webcam Logic ---
        captureBtn.addEventListener('click', () => {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            canvas.toBlob(blob => {
                capturedBlobs.push(blob);
                const thumbUrl = URL.createObjectURL(blob);
                const img = document.createElement('img');
                img.src = thumbUrl;
                webcamThumbnails.appendChild(img);
                registerWebcamBtn.disabled = false;
            }, 'image/jpeg');
        });

        registerWebcamBtn.addEventListener('click', async () => {
            const selectedOption = studentSelector.options[studentSelector.selectedIndex];
            const formData = new FormData();
            formData.append('roll_number', selectedOption.value);
            formData.append('name', selectedOption.dataset.name);
            capturedBlobs.forEach((blob, i) => formData.append('images', blob, `webcam_${i}.jpg`));
            
            registerWebcamBtn.disabled = true;
            const success = await registerFaces(formData);
            if (success) {
                capturedBlobs = [];
                webcamThumbnails.innerHTML = '';
            }
            registerWebcamBtn.disabled = false;
        });

        // --- File Upload Logic ---
        fileInput.addEventListener('change', () => {
            uploadThumbnails.innerHTML = '';
            registerUploadBtn.disabled = fileInput.files.length === 0;
            Array.from(fileInput.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    uploadThumbnails.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        });

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const selectedOption = studentSelector.options[studentSelector.selectedIndex];
            const formData = new FormData(uploadForm);
            formData.append('roll_number', selectedOption.value);
            formData.append('name', selectedOption.dataset.name);

            registerUploadBtn.disabled = true;
            const success = await registerFaces(formData);
            if (success) {
                fileInput.value = '';
                uploadThumbnails.innerHTML = '';
            }
            registerUploadBtn.disabled = false;
        });

    </script>
</body>
</html>
